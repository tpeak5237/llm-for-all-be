<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Quiz for all</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Taviraj:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // pdf.js worker
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js'
    }
  </script>
  <style>
    body {
      font-family: 'Taviraj', serif;
      line-height: 1.65;
      background: linear-gradient(135deg, #f8fafc 0%, #e0e7ef 100%);
      min-height: 100vh;
      background-image: url('https://www.transparenttextures.com/patterns/cubes.png');
      background-attachment: fixed;
    }
    h1, h2, h3 {
      font-family: 'Playfair Display', 'Taviraj', serif;
      font-weight: 700;
      line-height: 1.2;
      letter-spacing: -0.01em;
    }
    .main-card {
      background: rgba(255,255,255,0.95);
      max-width: 72rem;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 12px 40px rgba(139,94,60,0.18), 0 2px 8px rgba(212,175,55,0.12);
      border-radius: 1.5rem;
      border: 2px solid #8B5E3C;
      padding: 2rem;
      transition: box-shadow 0.3s, transform 0.2s;
    }
    .main-card:hover {
      box-shadow: 0 16px 50px rgba(139,94,60,0.22), 0 4px 12px rgba(212,175,55,0.14);
      transform: scale(1.01);
    }
    .prompt-frame {
      transition: box-shadow 0.3s, border-color 0.3s, transform 0.5s cubic-bezier(.4,2,.6,1);
      box-shadow: 0 4px 24px 0 rgba(139,94,60,0.10);
      border: 2.5px solid #8B5E3C;
      border-radius: 1.25rem;
      background: linear-gradient(90deg, #fff 80%, #f1f5f9 100%);
      position: sticky;
      top: 20px;
    }
    .fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #8B5E3C;
      color: #fff;
      display: grid;
      place-items: center;
      box-shadow: 0 12px 20px rgba(139,94,60,0.35), 0 2px 6px rgba(212,175,55,0.2);
      cursor: pointer;
      user-select: none;
    }
    code.json {
      white-space: pre-wrap;
      word-break: break-word;
    }
    .badge {
      border-radius: 9999px;
      padding: 2px 10px;
      font-size: 12px;
      font-weight: 600;
      background: #d4af37;
      color: #fff;
      font-family: 'Taviraj', serif;
    }
    .opt { cursor: pointer; user-select: none; transition: background .15s, border-color .15s }
    .opt:hover { background: #f1f5f9 }
    .opt.correct { border-color: #22c55e; background: #ecfdf5 }
    .opt.wrong { border-color: #ef4444; background: #fef2f2 }
    .judge { font-weight: 600; margin-top: .25rem }
  .judge.ok { color: #d4af37; font-family: 'Taviraj', serif; }
  .judge.no { color: #8B5E3C; font-family: 'Taviraj', serif; }
    /* Prevent copying questions and answers */
    #quizOut, #answerOut { 
      -webkit-user-select: none; 
      -moz-user-select: none; 
      -ms-user-select: none; 
      user-select: none; 
    }
    /* Allow typing and selecting inside inputs if needed */
    #quizOut input, #quizOut textarea { 
      -webkit-user-select: text; 
      -moz-user-select: text; 
      -ms-user-select: text; 
      user-select: text; 
    }
  </style>
</head>
<body class="px-4 sm:px-6 py-8">
  <header class="max-w-5xl mx-auto mb-6 text-center">
  <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight text-[#8B5E3C]" style="font-family: 'Playfair Display', 'Taviraj', serif;">Quiz for all</h1>
    <p class="text-slate-600 mt-2">สร้างโจทย์การเรียนง่ายๆ ได้เพียงปลายนิ้ว</p>
  </header>

  <main class="max-w-5xl mx-auto main-card p-4 sm:p-6">
    <!-- Keys and model config -->
    <section id="apiSettings" class="mb-4" style="display:none">
      <details class="select-none">
        <summary class="cursor-pointer text-slate-700 font-semibold">API settings</summary>
        <div class="mt-3 grid sm:grid-cols-3 gap-3">
          <div>
            <label class="block text-sm text-slate-600 mb-1">Gemini API Key</label>
            <input id="geminiKey" type="password" class="w-full border rounded-lg px-3 py-2" placeholder="AIzaSy Ai7g9ktQXUYoj0F9j_cgTpQQhIM1CVcHQ">
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">Model</label>
          <input id="modelName" type="text" class="w-full border rounded-lg px-3 py-2" value="gemma-3-27b-it">
          </div>
          <div class="sm:col-span-3">
            <button id="saveKeys" class="mt-1 bg-slate-800 text-white px-4 py-2 rounded-lg">Save keys to this browser</button>
            <span id="saveNote" class="ml-2 text-sm text-slate-600"></span>
          </div>
        </div>
      </details>
    </section>

    <!-- Input area -->
    <section>
      <div class="grid md:grid-cols-2 gap-4">
        <div class="prompt-frame p-3 sm:p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold text-slate-800">Source content</h2>
            <div class="flex gap-2">
              <label class="cursor-pointer bg-[#8B5E3C] hover:bg-[#d4af37] text-white px-3 py-2 rounded-lg">
                <input id="fileInput" type="file" accept="application/pdf,image/*" multiple class="hidden">
                Upload files
              </label>
              <button id="clearSource" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-3 py-2 rounded-lg">Clear</button>
            </div>
          </div>
          <textarea id="sourceText" rows="12" class="w-full bg-white border rounded-lg p-3 outline-none" placeholder="Paste text here or upload files (PDF or images)"></textarea>
          <p id="pdfStatus" class="text-sm text-slate-500 mt-2"></p>
        </div>

        <div class="prompt-frame p-3 sm:p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold text-slate-800">Controls</h2>
          </div>

          <div class="grid gap-3">
            <label class="block">
              <span class="text-sm text-slate-600">Quiz length</span>
            <input id="quizLen" type="number" min="3" max="60" value="10" class="w-full border rounded-lg px-3 py-2">
            </label>

            <label class="block">
              <span class="text-sm text-slate-600">Focus</span>
              <input id="focus" type="text" placeholder="Optional topic or chapter filter" class="w-full border rounded-lg px-3 py-2">
            </label>

            <div class="flex items-center gap-2">
              <input id="mathSciBias" type="checkbox" class="w-4 h-4">
              <label for="mathSciBias" class="text-sm text-slate-700">Prefer math or science style with equations</label>
            </div>

            <div class="flex gap-2 mt-2">
             <button id="quizBtn" class="bg-[#8B5E3C] hover:bg-[#d4af37] text-white px-4 py-2 rounded-lg w-full disabled:bg-gray-400 disabled:hover:bg-gray-400 disabled:cursor-not-allowed disabled:opacity-70">Generate quiz</button>
            </div>

            <div class="flex gap-2">
              <button id="exportBtn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 px-4 py-2 rounded-lg" disabled>Download JSON</button>
            </div>

            <div class="mt-2">
              <label class="text-sm text-slate-600">Accuracy</label>
              <div class="w-full bg-slate-200 rounded-lg overflow-hidden h-3">
                <div id="accBar" class="h-3 bg-green-500" style="width: 0%"></div>
              </div>
              <p id="accText" class="text-sm text-slate-700 mt-1">0 percent</p>
            </div>

            <div id="ecoStats" class="mt-3 p-2 rounded text-sm hidden bg-green-100 text-green-800 border border-green-300"></div>
          </div>
        </div>
      </div>
      <!-- <p class="text-xs text-gray-500 text-center mt-2">Powered by LLMall 1</p> -->
    </section>

    <!-- Output -->
    <section id="resultsSection" class="mt-6 hidden">
      <h2 class="font-semibold text-slate-800 mb-2">Quiz</h2>
      <div id="quizOut" class="space-y-3"></div>

      <h2 class="font-semibold text-slate-800 mt-6 mb-2">Answer key</h2>
      <div id="answerOut" class="space-y-2"></div>

      <h2 class="font-semibold text-slate-800 mt-6 mb-2">Your score</h2>
      <div id="accOut" class="space-y-2"></div>

      <div id="rawJsonSection" class="hidden">
        <h2 class="font-semibold text-slate-800 mt-6 mb-2">Raw JSON</h2>
        <pre class="bg-slate-900 text-green-200 p-3 rounded-lg overflow-x-auto"><code id="jsonOut" class="json"></code></pre>
      </div>
    </section>
  </main>

  <div id="fab" class="fab" title="Scroll to top">↑</div>

  <script>
    const WORKER_BASE = 'https://llm-for-all-be.onrender.com';
const origFetch = window.fetch;
window.fetch = function(input, init){
  try {
    const url = typeof input === 'string' ? input : input.url;
    if (typeof url === 'string' && url.startsWith('https://generativelanguage.googleapis.com')) {
      const body = init && init.body ? init.body : null;
      return origFetch(`${WORKER_BASE}/call-ai`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body
      });
    }
  } catch (e) {}
  return origFetch(input, init);
};

    
    // Try to reuse keys if index.html exposes them
    const FORCED_GEMINI_KEY = "AIzaSyAi7g9ktQXUYoj0F9j_cgTpQQhIM1CVcHQ";
    const indexApiKey = ""  // require user to enter their own key

    // Local storage helpers
    const getKey = (k) => localStorage.getItem(k) || ''
    const setKey = (k, v) => localStorage.setItem(k, v)

    // Elements
    const sourceEl = document.getElementById('sourceText')
    const pdfStatus = document.getElementById('pdfStatus')
    const quizBtn = document.getElementById('quizBtn')
    const exportBtn = document.getElementById('exportBtn')
    const quizOut = document.getElementById('quizOut')
    const answerOut = document.getElementById('answerOut')
    const resultsSection = document.getElementById('resultsSection')
    // Disable copy and context menu within quiz and answer sections
    ;['quizOut','answerOut'].forEach(id => {
      const el = document.getElementById(id)
      if (!el) return
      ;['copy','cut','contextmenu','dragstart'].forEach(evt => {
        el.addEventListener(evt, e => {
          e.preventDefault()
          return false
        })
      })
    })
    const jsonOut = document.getElementById('jsonOut')
    const accOut = document.getElementById('accOut')
    const accBar = document.getElementById('accBar')
    const accText = document.getElementById('accText')
    const saveKeysBtn = document.getElementById('saveKeys')
    const saveNote = document.getElementById('saveNote')
    const geminiKeyInput = document.getElementById('geminiKey')
    const modelNameInput = document.getElementById('modelName')
    const clearSourceBtn = document.getElementById('clearSource')
    const quizLenInput = document.getElementById('quizLen')
    const focusInput = document.getElementById('focus')
    const mathSciBias = document.getElementById('mathSciBias')

    // Preload any known keys
    if (geminiKeyInput) geminiKeyInput.value = ''

    if (saveKeysBtn) {
      saveKeysBtn.addEventListener('click', () => {
        setKey('gemini_model', (modelNameInput && modelNameInput.value.trim()) || 'gemma-3-27b-it')
        if (saveNote) {
          saveNote.textContent = 'Saved in this browser'
          setTimeout(() => saveNote.textContent = '', 1500)
        }
      })
    }

    clearSourceBtn.addEventListener('click', () => {
      sourceEl.value = ''
      pdfStatus.textContent = ''
      if (resultsSection) resultsSection.classList.add('hidden')
    })

    document.getElementById('fab').addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }))

    // Direct file attach to Gemini
    const fileInputEl = document.getElementById('fileInput')
    let attachedFiles = []

    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader()
        reader.onload = () => {
          const res = String(reader.result || '')
          const idx = res.indexOf(',')
          resolve(idx >= 0 ? res.slice(idx + 1) : res)
        }
        reader.onerror = () => reject(new Error('read error'))
        reader.readAsDataURL(file)
      })
    }

    fileInputEl.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files || [])
      // 20 MB = 20 * 1024 * 1024 bytes
      const MAX_SIZE = 20 * 1024 * 1024;
      const validFiles = [];
      files.forEach(f => {
        if (f.size > MAX_SIZE) {
          alert(`File too large (max 20 MB): ${f.name}`);
        } else {
          validFiles.push(f);
        }
      });
      attachedFiles = validFiles;
      if (!validFiles.length) { pdfStatus.textContent = '' ; return }
      const names = validFiles.map(f => f.name).join(', ')
      pdfStatus.textContent = `Attached ${validFiles.length} file(s): ${names}`
    })

    // Gemini call

    async function callGemini(userPartsOrText) {
      const apiKey = FORCED_GEMINI_KEY
      const model = (modelNameInput && modelNameInput.value.trim()) || getKey('gemini_model') || 'gemini-2.5-flash'
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`
      const parts = Array.isArray(userPartsOrText) ? userPartsOrText : [{ text: String(userPartsOrText || '') }]
      const body = {
        contents: [ { role: 'user', parts } ],
        generationConfig: {
          temperature: 0.7,
          candidateCount: 1,
          maxOutputTokens: 32000
        }
      }
      const response = await fetch(url, {
        method: 'POST',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      if (!response.ok) {
        let msg = 'Gemini API returned status ' + response.status;
        if (response.status === 401 || response.status === 403) msg = 'Gemini API key invalid or quota exhausted';
        throw new Error(msg);
      }
      const data = await response.json();

      // Guard: some responses use top-level finishReason and a bare content object
      if (data && data.finishReason === 'MAX_TOKENS') {
        throw new Error('Model token limit reached, try fewer questions or shorter source')
      }
      if (data && !data.candidates && data.content && typeof data.content.text !== 'string') {
        // No usable text payload
        console.warn('Model returned bare content without text:', data)
        throw new Error('No text from model')
      }

      // Handle direct content response without candidates
      if (data.content && !data.candidates) {
        if (data.content.finishReason === 'MAX_TOKENS') {
          throw new Error('Model token limit reached, try fewer questions or shorter source');
        }
        // If content.text is present, return it
        if (typeof data.content.text === 'string') {
          return data.content.text;
        }
      }

      // Helper: base64 decode (url-safe, padded)
      function b64ToString(b64) {
        try {
          // normalize url-safe base64
          const norm = b64.replace(/-/g, '+').replace(/_/g, '/');
          // pad to length multiple of 4
          const pad = norm + '==='.slice((norm.length + 3) % 4);
          return atob(pad);
        } catch { return ''; }
      }

      // Helper: extract text from a part
      function partToText(part) {
        if (!part || typeof part !== 'object') return '';
        if (typeof part.text === 'string' && part.text.trim()) return part.text;
        if (part.inline_data && part.inline_data.data) {
          const s = b64ToString(String(part.inline_data.data || ''));
          return s || '';
        }
        if (part.functionCall && part.functionCall.args) {
          try {
            const a = part.functionCall.args;
            if (typeof a === 'string') return a;
            if (a.json) return typeof a.json === 'string' ? a.json : JSON.stringify(a.json);
            return JSON.stringify(a);
          } catch { return ''; }
        }
        if (part.functionResponse && part.functionResponse.response) {
          try { return JSON.stringify(part.functionResponse.response); } catch { return ''; }
        }
        return '';
      }

      let text = '';
      try {
        const cand = data && Array.isArray(data.candidates) ? data.candidates[0] : null;
        if (cand && cand.content && Array.isArray(cand.content.parts)) {
          const partsText = cand.content.parts.map(partToText).filter(Boolean).join('\n');
          text = partsText;
        }
        // If still empty, do a deep sweep for any recognizable text or inline json
        if (!text) {
          const sweep = [];
          (function walk(o){
            if (!o) return;
            if (Array.isArray(o)) { o.forEach(walk); return; }
            if (typeof o === 'object') {
              if ('text' in o && typeof o.text === 'string' && o.text.trim()) sweep.push(o.text);
              if (o.inline_data && o.inline_data.data) sweep.push(b64ToString(String(o.inline_data.data)));
              walk(Object.values(o));
            }
          })(data);
          text = sweep.filter(Boolean).join('\n');
        }
      } catch (e) {
        console.error('Parsing error:', e);
      }

      // Final fallbacks if still empty
      if (!text || !text.trim()) {
        try {
          const cand = data && Array.isArray(data.candidates) ? data.candidates[0] : null;
          if (cand && cand.content && Array.isArray(cand.content.parts)) {
            // stringify parts so downstream can slice out JSON
            text = JSON.stringify(cand.content.parts);
          }
          if (!text || !text.trim()) {
            // last resort stringify the whole candidate
            text = JSON.stringify(cand || data || {});
          }
        } catch {}
      }

      if (!text || !text.trim()) {
        console.error('Unexpected model response shape:', data);
        throw new Error('No text from model');
      }
      return text;
    }

    function extractJSON(input) {
      if (input === undefined || input === null) throw new Error('Empty response')

      // If the model already returned a JS object/array, accept it directly
      if (typeof input === 'object') return input

      // Normalize string
      let t = String(input)
        .replace(/^\uFEFF/, '') // BOM
        .replace(/```(?:json)?\s*([\s\S]*?)\s*```/gi, '$1') // code fences
        .replace(/[\u201C\u201D]/g, '"') // smart double quotes
        .replace(/[\u2018\u2019]/g, "'") // smart single quotes
        .trim()

      // 1) Direct parse
      try { return JSON.parse(t) } catch (e) {}

      // 2) Try to grab the largest object or array block
      const trySlice = (str) => {
        let s = str
        // Remove any leading noise before first brace/bracket
        const firstCurly = s.indexOf('{')
        const firstBrack = s.indexOf('[')
        let start = -1
        if (firstCurly !== -1 && firstBrack !== -1) start = Math.min(firstCurly, firstBrack)
        else start = Math.max(firstCurly, firstBrack)
        if (start > 0) s = s.slice(start)

        const lastCurly = s.lastIndexOf('}')
        const lastBrack = s.lastIndexOf(']')
        let end = -1
        if (lastCurly !== -1 && lastBrack !== -1) end = Math.max(lastCurly, lastBrack)
        else end = Math.max(lastCurly, lastBrack)
        if (end !== -1) s = s.slice(0, end + 1)

        // Remove trailing commas like ,}\n or ,]\n
        s = s.replace(/,\s*([}\]])/g, '$1')

        try { return JSON.parse(s) } catch (e) { return null }
      }
      const sliced = trySlice(t)
      if (sliced) return sliced

      // 3) Sometimes JSON is double-escaped like "{\"questions\":...}"
      try {
        // Remove wrapping quotes if present, then unescape
        let u = t
        if ((u.startsWith('"') && u.endsWith('"')) || (u.startsWith("'") && u.endsWith("'"))) {
          u = u.slice(1, -1)
        }
        u = u.replace(/\\"/g, '"').replace(/\\n/g, '\n')
        return JSON.parse(u)
      } catch (e) {}

      throw new Error('Could not parse JSON')
    }

    function normalizeQuiz(raw) {
      try {
        if (raw == null) return null
        const obj = typeof raw === 'string' ? extractJSON(raw) : raw
        let out = null

        // Unwrap common wrappers
        if (Array.isArray(obj)) out = { questions: obj }
        if (!out && obj.questions && Array.isArray(obj.questions)) out = { ...obj, questions: obj.questions }
        if (!out && obj.quiz && obj.quiz.questions && Array.isArray(obj.quiz.questions)) out = { ...obj.quiz }
        if (!out && obj.data && obj.data.questions && Array.isArray(obj.data.questions)) out = { ...obj.data }
        if (!out && obj.items && Array.isArray(obj.items)) out = { questions: obj.items }
        if (!out && obj.qs && Array.isArray(obj.qs)) out = { questions: obj.qs }

        // Shape: {questions:[], answers:[]}
        if (!out && obj.questions && obj.answers && Array.isArray(obj.questions)) {
          out = { questions: obj.questions }
          out.questions.forEach((q, i) => {
            if (q && (q.answer == null || q.answer === '') && Array.isArray(obj.answers) && obj.answers[i] != null) {
              q.answer = obj.answers[i]
            }
          })
        }

        if (!out) out = obj

        // If we still don't have {questions:[]}, but obj itself is an array
        if (!out.questions && Array.isArray(out)) out = { questions: out }

        if (!out.questions || !Array.isArray(out.questions)) return null

        // Normalize each question
        out.questions = out.questions.map((q, idx) => {
          if (q == null) return { question: `Question ${idx + 1}`, type: 'short', answer: '' }
          if (typeof q === 'string') return { question: q, type: 'short', answer: '' }

          const qq = { ...q }
          if (!qq.question && qq.prompt) qq.question = qq.prompt
          if (!qq.question && qq.q) qq.question = qq.q

          // answers
          if (qq.answer == null) {
            if (qq.correct != null) qq.answer = qq.correct
            else if (qq.answers != null) qq.answer = Array.isArray(qq.answers) ? qq.answers[0] : qq.answers
            else if (qq.key != null) qq.answer = qq.key
          }

          // type
          if (!qq.type) qq.type = Array.isArray(qq.options) || (qq.choices && Array.isArray(qq.choices)) ? 'mcq' : 'short'

          // Normalize options shapes
          if (!qq.options && qq.choices && Array.isArray(qq.choices)) qq.options = qq.choices
          if (qq.options && !Array.isArray(qq.options) && typeof qq.options === 'object') {
            const order = ['A','B','C','D','E','F']
            qq.options = order.map(k => qq.options[k]).filter(v => v != null)
          }

          // Strings for meta
          if (qq.topics && typeof qq.topics !== 'string') qq.topics = String(qq.topics)
          if (qq.bloom_level && typeof qq.bloom_level !== 'string') qq.bloom_level = String(qq.bloom_level)
          if (qq.difficulty && typeof qq.difficulty !== 'string') qq.difficulty = String(qq.difficulty)

          if (!qq.question) qq.question = `Question ${idx + 1}`
          if (qq.answer == null) qq.answer = ''
          return qq
        })

        if (out.tldr && typeof out.tldr !== 'string') out.tldr = String(out.tldr)
        if (!out.tldr) out.tldr = ''
        if (out.notes && typeof out.notes !== 'string') out.notes = String(out.notes)
        if (!out.notes) out.notes = ''

        return out
      } catch (e) {
        console.error('normalizeQuiz error', e)
        return null
      }
    }

    // === Interactive helpers ===
    function stripChoiceLabel(s) {
      if (typeof s !== 'string') return s
      return s.replace(/^\s*[A-Z]\s*[\)\.]\s*/i, '').trim()
    }
    function norm(s) {
      if (s == null) return ''
      return String(s).toLowerCase().replace(/[^a-z0-9\.\-]+/g,' ').trim().replace(/\s+/g,' ')
    }
    function guessAnswerIndex(options, answer) {
      if (!Array.isArray(options)) return -1
      const ans = String(answer || '').trim()
      // letter form
      if (/^[A-Za-z]/.test(ans)) {
        const idx = ans[0].toUpperCase().charCodeAt(0) - 65
        if (idx >= 0 && idx < options.length) return idx
      }
      // match by text
      const nAns = norm(stripChoiceLabel(ans))
      let best = -1
      options.forEach((o,i)=>{ if (norm(stripChoiceLabel(o)) === nAns) best = i })
      return best
    }

    // Eco stats helpers
    function estimateWater(chars) {
      const BASE_PROMPT_CHARS = 1000;
      const BASE_PROMPT_WATER_ML = 0.045; // Gemma 27B ~0.045 mL per 1000 chars
      const ml = (chars / BASE_PROMPT_CHARS) * BASE_PROMPT_WATER_ML;
      return Math.max(0.0005, ml);
    }
    function estimateEnergy(chars) {
      const BASE_PROMPT_CHARS = 1000;
      const BASE_PROMPT_ENERGY_WH = 0.045; // Gemma 27B ~0.045 Wh per 1000 chars
      const wh = (chars / BASE_PROMPT_CHARS) * BASE_PROMPT_ENERGY_WH;
      return Math.max(0.0001, wh);
    }
    function showEcoStats(charCount) {
      const ecoStatsEl = document.getElementById('ecoStats');
      if (!ecoStatsEl) return;
      const waterMl = estimateWater(charCount);
      const energyWh = estimateEnergy(charCount);
      const pageCount = Math.ceil(charCount / 2500);
      const co2Kg = pageCount * 0.0045; // Using average of 0.0043 and 0.0047
      ecoStatsEl.innerHTML = `Est. water: ${waterMl.toFixed(3)} ml &bull; Est. energy: ${energyWh.toFixed(3)} Wh &bull; CO2 Saved: ~${co2Kg.toFixed(4)} kg`;
      ecoStatsEl.classList.remove('hidden');
      setTimeout(() => ecoStatsEl.classList.add('hidden'), 8000);
    }

    // AI grading helper for short answers
    async function aiJudgeShort(question, userAnswer, goldAnswer) {
      const prompt = [
        'You are a strict grader.',
        'Decide if USER_ANSWER is correct for QUESTION given OFFICIAL_ANSWER.',
        'Treat minor wording differences as correct.',
        'For numbers, accept within 1 percent or exact unit conversion.',
        'Return JSON: {"ok": true|false, "reason": "short note"}',
        '',
        'QUESTION:', question,
        'OFFICIAL_ANSWER:', goldAnswer,
        'USER_ANSWER:', userAnswer
      ].join('\n');
      const raw = await callGemini([{ text: prompt }]);
      const obj = extractJSON(raw);
      return { ok: !!obj.ok, reason: obj.reason || '' };
    }
    function numbersClose(a,b){
      const x = Number(a), y = Number(b)
      if (!isFinite(x) || !isFinite(y)) return false
      const eps = 1e-6
      const diff = Math.abs(x-y)
      return diff <= eps || diff <= Math.max(Math.abs(x),Math.abs(y)) * 0.01
    }

    function renderQuiz(q) {
      quizOut.innerHTML = ''
      answerOut.innerHTML = ''
      jsonOut.textContent = JSON.stringify(q, null, 2)
      exportBtn.disabled = false

      const state = { total: q.questions.length, answered: 0, correct: 0 }
      const scoreBox = document.createElement('div')
      scoreBox.className = 'mb-3 text-sm text-slate-700'
      scoreBox.id = 'scoreBox'
      scoreBox.textContent = `Score 0 / ${state.total}`
      quizOut.appendChild(scoreBox)

      // Live percent scoring UI updater
      const updateScoreUI = () => {
        const pct = Math.round((state.correct / state.total) * 100)
        accBar.style.width = pct + '%'
        accBar.className = 'h-3 ' + (pct >= 85 ? 'bg-green-500' : pct >= 60 ? 'bg-yellow-500' : 'bg-red-500')
        accText.textContent = pct + ' percent'
        scoreBox.textContent = `Score ${state.correct} / ${state.total}`
        if (state.answered === state.total) {
          accOut.innerHTML = `<div class="rounded-lg border p-3 bg-white">Your score is ${pct} percent.</div>`
        } else {
          accOut.innerHTML = ''
        }
      }

      q.questions.forEach((it, idx) => {
        // sanitize options
        if (Array.isArray(it.options)) it.options = it.options.map(stripChoiceLabel)

        const card = document.createElement('div')
        card.className = 'rounded-lg border p-3 bg-white'
        const head = document.createElement('div')
        head.className = 'font-semibold text-slate-800 text-lg'
        head.textContent = `${idx + 1}. ${it.question}`
        card.appendChild(head)

        const verdict = document.createElement('div')
        verdict.className = 'judge hidden'
        card.appendChild(verdict)

        // MCQ interaction
        if (it.type === 'mcq' && Array.isArray(it.options)) {
          const list = document.createElement('ul')
          list.className = 'mt-2 grid sm:grid-cols-2 gap-2'

          const correctIdx = guessAnswerIndex(it.options, it.answer)

          it.options.forEach((opt, i) => {
            const li = document.createElement('li')
            li.className = 'opt border rounded-lg px-3 py-2 bg-slate-50 flex items-start gap-2'
            li.setAttribute('role','button')
            const badge = document.createElement('span')
            badge.className = 'badge bg-slate-200 text-slate-700'
            badge.textContent = String.fromCharCode(65 + i)
            const txt = document.createElement('span')
            txt.textContent = opt
            li.appendChild(badge)
            li.appendChild(txt)

            li.addEventListener('click', async () => {
              if (card.dataset.done) return
              card.dataset.done = 'y'
              state.answered++
              const ok = i === correctIdx || norm(opt) === norm(it.answer)
              if (ok) {
                state.correct++;
                li.classList.add('correct');
                verdict.textContent = 'Correct';
                verdict.classList.add('ok');
                verdict.classList.remove('hidden');
                // mark the correct choice if not already
                updateScoreUI();
              } else {
                li.classList.add('wrong');
                verdict.classList.add('no');
                // mark the correct choice
                if (correctIdx >= 0 && list.children[correctIdx]) list.children[correctIdx].classList.add('correct');
                verdict.textContent = 'Checking...';
                verdict.classList.remove('hidden');
                try {
                  const res = await aiJudgeShort(it.question, opt, it.answer);
                  const reason = res && res.reason ? res.reason : '';
                  verdict.textContent = reason
                    ? `Wrong. ${reason}\nCorrect answer: ${it.options[correctIdx] !== undefined ? it.options[correctIdx] : it.answer}`
                    : `Wrong. Correct answer: ${it.options[correctIdx] !== undefined ? it.options[correctIdx] : it.answer}`;
                } catch (err) {
                  verdict.textContent = `Wrong. Correct answer: ${it.options[correctIdx] !== undefined ? it.options[correctIdx] : it.answer}`;
                }
                updateScoreUI();
              }
            })

            list.appendChild(li)
          })
          card.appendChild(list)
        }

        // Short or calc free response
        if (it.type !== 'mcq') {
          const form = document.createElement('form')
          form.className = 'mt-2 flex gap-2 items-center'
          const inp = document.createElement('input')
          inp.type = 'text'
          inp.className = 'border rounded-lg px-3 py-2 flex-1'
          inp.placeholder = 'Type your answer'
          const btn = document.createElement('button')
          btn.type = 'submit'
          btn.className = 'bg-slate-800 text-white px-3 py-2 rounded-lg'
          btn.textContent = 'Check'
          form.appendChild(inp); form.appendChild(btn)

          form.addEventListener('submit', async e => {
            e.preventDefault();
            if (card.dataset.done) return;
            const guess = inp.value.trim();
            const gold = String(it.answer == null ? '' : it.answer);
            let ok = false; let reason = '';
            try {
              const res = await aiJudgeShort(it.question, guess, gold);
              ok = !!res.ok; reason = res.reason || '';
            } catch (err) {
              // Fallback to strict comparison if model grading fails
              if (numbersClose(guess, gold) || norm(guess) === norm(gold)) ok = true;
            }
            card.dataset.done = 'y';
            state.answered++;
            if (ok) { state.correct++; verdict.textContent = 'Correct'; verdict.classList.add('ok'); }
            else { verdict.textContent = reason ? `Wrong. ${reason}` : `Wrong, answer is ${gold}`; verdict.classList.add('no'); }
            verdict.classList.remove('hidden');
            updateScoreUI()
          });

          card.appendChild(form)
        }

        // Remove evidence/solution block under each question
        // if (it.solution_steps) {
        //   const sol = document.createElement('pre')
        //   sol.className = 'bg-slate-900 text-green-200 rounded-lg p-2 mt-2 overflow-x-auto'
        //   sol.textContent = it.solution_steps
        //   card.appendChild(sol)
        // }

        const meta = document.createElement('div')
        meta.className = 'mt-2 text-xs text-slate-600'
        meta.textContent = [it.topics ? `topics: ${it.topics}` : '', it.bloom_level ? `bloom: ${it.bloom_level}` : '', it.difficulty ? `difficulty: ${it.difficulty}` : ''].filter(Boolean).join(' • ')
        if (meta.textContent) card.appendChild(meta)

        quizOut.appendChild(card)

        const ansRow = document.createElement('div')
        ansRow.setAttribute('draggable','false')
        ansRow.className = 'rounded-lg border p-2 bg-white'
        ansRow.textContent = `${idx + 1}. ${it.answer}`
        answerOut.appendChild(ansRow)
      })
    }

    function setBusy(b) {
      quizBtn.disabled = b
      exportBtn.disabled = b || !jsonOut.textContent
      quizBtn.textContent = b ? 'Working' : 'Generate quiz'
      if (b && resultsSection) {
        resultsSection.classList.add('hidden')
      }
    }

    quizBtn.addEventListener('click', async () => {
      setBusy(true)
      try {
        const n = Math.max(3, Math.min(60, parseInt(quizLenInput.value || '10', 10)))
        const focus = focusInput.value.trim()
        const bias = mathSciBias.checked ? 'Prefer math or science style and include equations where relevant' : 'Keep style neutral'

        const instruction = [
          'You are an educator who writes rigorous assessments',
          'Given the SOURCE text and any ATTACHED FILES, produce a quiz as strict JSON with this shape',
          '{',
          ' "questions": [',
          '   { "question": string, "type": "mcq|short|calc", "options": [A,B,C,D] optional, "answer": string,',
          '     "solution_steps": string optional, "topics": string, "bloom_level": string, "difficulty": "easy|medium|hard" }',
          ' ],',
          ' "tldr": string,',
          ' "notes": string',
          '}',
          `Aim for ${n} questions`,
          focus ? `Focus on: ${focus}` : 'General coverage',
          bias,
          'If files are attached, extract text from PDFs and images directly. Do not summarize file names.',
          'Return only JSON. No markdown. No code fences.',
          'SOURCE:'
        ].join('\n')

        let parts = [ { text: instruction } ]
        const src = sourceEl.value.trim()
        if (src) parts.push({ text: src })

        // Attach files as inline data
        if (attachedFiles && attachedFiles.length) {
          const b64s = await Promise.all(attachedFiles.map(readFileAsBase64))
          attachedFiles.forEach((f, i) => {
            parts.push({ inline_data: { data: b64s[i], mime_type: f.type || 'application/octet-stream' } })
          })
        }

        const raw = await callGemini(parts)
        const data = extractJSON(raw)
        const normalized = normalizeQuiz(data)
        if (!normalized || !Array.isArray(normalized.questions) || !normalized.questions.length) {
          console.warn('Model output (raw):', raw)
          console.warn('Parsed object:', data)
          throw new Error('Bad JSON shape')
        }
        const sourceCharCount = (sourceEl.value || '').length;
        const quizCharCount = JSON.stringify(normalized).length;
        showEcoStats(sourceCharCount + quizCharCount);
        renderQuiz(normalized)
        accOut.innerHTML = ''
        accBar.style.width = '0%'
        accText.textContent = '0 percent'
        window.__quizJSON = normalized
        if (resultsSection) resultsSection.classList.remove('hidden')
      } catch (e) {
        console.error(e)
        alert('Failed to generate quiz: ' + (e && e.message ? e.message : e))
      } finally {
        setBusy(false)
      }
    })


    exportBtn.addEventListener('click', () => {
      const dataStr = (jsonOut.textContent && jsonOut.textContent.trim())
        ? jsonOut.textContent
        : JSON.stringify(window.__quizJSON || {}, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'quiz.json';
      a.click();
      URL.revokeObjectURL(url);
      exportBtn.textContent = 'Downloaded';
      setTimeout(() => exportBtn.textContent = 'Download JSON', 1000);
    });
  </script>

  <footer class="max-w-5xl mx-auto text-center mt-6">
    <div id="projectInfo">
      <h2 class="text-xl font-semibold text-[#8B5E3C]">ปัญญาประดิษฐ์เพื่อการเป็นมิตรต่อสิ่งแวดล้อมและอยู่ในจริยธรรมทางปัญญาประดิษฐ์ที่ถูกต้อง</h2>
      <p class="text-slate-700 mt-1">ระดับชั้น ม.3/5</p>
      <div class="mt-3 text-slate-800 text-left inline-block">
        <p>1) เด็กชาย นิธิศ โพธิ์ลีลาธรรม เลขที่ 6</p>
        <p>2) เด็กชาย ติณณ์ศดิศ บัณฑิตเอกตระกูล เลขที่ 13</p>
        <p>3) เด็กชาย ธีรภัทรส์ พงษ์เกษม เลขที่ 14</p>
        <p>4) เด็กชาย พัสกร บุญบูรพงษ์ เลขที่ 17</p>
        <p>5) เด็กชาย แทนคุณ เซี่ยงฉิน เลขที่ 21</p>
        <p>6) เด็กชาย ธนกฤต บุญรักษาตระกูล เลขที่ 26</p>
        <p>7) เด็กชาย กรวิชญ์ เพียรผลดีสกุล เลขที่ 27</p>
        <p>8) เด็กชาย ศุภรุจ ศรีหะรัญ เลขที่ 39</p>
      </div>
      <p class="text-[#8B5E3C] font-bold mt-4">โครงงาน AC Innovation ม.3<br>Since 29 May 2025</p>
      <nav id="quickLinks" class="mt-4 [#8B5E3C]flex flex-col items-center gap-3">
        <center><a href="index.html" class="block w-full max-w-xs text-center bg-[#8B5E3C] hover:[#8B5E3C] text-white font-semibold py-2 px-4 rounded-xl shadow text-sm">LLM for all &gt;</a></center>
      </nav>
    </div>
  </footer>
</body>
  <!-- Login and lockscreen logic restored above -->
</html>
