<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Step by Step for all</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Taviraj:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Taviraj', serif;
      line-height: 1.65;
      background: linear-gradient(135deg, #f8fafc 0%, #e0e7ef 100%);
      min-height: 100vh;
      background-image: url('https://www.transparenttextures.com/patterns/cubes.png');
    }
    h1, h2, h3 {
      font-family: 'Playfair Display', 'Taviraj', serif;
      font-weight: 700;
      line-height: 1.2;
      letter-spacing: -0.01em;
    }
    .main-card {
      background: rgba(255,255,255,0.95);
      max-width: 72rem;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 6px 32px 0 rgba(139,94,60,0.13), 0 1.5px 6px 0 rgba(212,175,55,0.08);
      border-radius: 1.5rem;
      border: 2px solid #8B5E3C;
      padding: 2rem;
      transition: box-shadow 0.3s, transform 0.2s;
    }
    .main-card:hover {
      box-shadow: 0 20px 60px 0 rgba(139,94,60,0.22), 0 4px 16px 0 rgba(212,175,55,0.13);
      transform: scale(1.01);
    }
    .prompt-frame {
      transition: box-shadow 0.3s, border-color 0.3s, transform 0.5s cubic-bezier(.4,2,.6,1);
      box-shadow: 0 4px 24px 0 rgba(139,94,60,0.10);
      border: 2.5px solid #8B5E3C;
      border-radius: 1.25rem;
      background: linear-gradient(90deg, #fff 80%, #f1f5f9 100%);
      position: relative;
    }
    .step-num {
      width: 2rem;
      height: 2rem;
      border-radius: 9999px;
      background: #8B5E3C;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      flex-shrink: 0;
    }
    .step-text.blurred {
      filter: blur(7px);
      -webkit-filter: blur(7px);
      user-select: none;
    }
    .step-card {
      border: 1.5px solid #8B5E3C;
      border-radius: 0.75rem;
      background: #ffffff;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex items-center justify-center flex-col p-4 selection:bg-yellow-500 selection:text-black">


  <div class="main-card p-0 md:p-0 w-full max-w-5xl flex space-x-0 md:space-x-6 border-0 md:border-2 border-gray-300">
    <div class="flex-grow w-2/3 flex flex-col px-2 md:px-8 py-6">
      <header class="mb-6 relative">
        <h1 class="text-4xl md:text-5xl font-extrabold text-[#8B5E3C] drop-shadow-sm tracking-tight header-title text-center">Step by Step for all</h1>
        <p class="text-[#8B5E3C] mt-2 text-base md:text-lg font-medium text-center">การเรียนต้องมีขั้นตอน สอนการทำงานได้ในปลายนิ้ว</p>
      </header>


  <main class="flex-grow flex flex-col">
    <div id="promptFrame" class="flex flex-col items-center w-full max-w-full md:max-w-2xl mb-4 mx-auto">
      <div class="flex w-full items-center space-x-3 border border-[#8B5E3C] rounded-full px-4 py-3 bg-gray-50">
        <label for="fileInput" class="file-input-label shrink-0 w-12 h-12 flex items-center justify-center border-2 border-dashed border-gray-300 rounded-lg bg-white cursor-pointer" title="Upload a file">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 md:w-7 md:h-7">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
          </svg>
        </label>
        <input type="file" id="fileInput" multiple class="hidden">
        <textarea
          id="problemInput"
          rows="1"
          placeholder="Enter a prompt here..."
          class="flex-grow bg-transparent text-gray-800 placeholder-gray-400 focus:outline-none resize-none overflow-y-auto min-h-[3.5rem] max-h-[6rem] text-base md:text-lg leading-normal px-2"
        ></textarea>
        <button id="generateButton" class="bg-[#8B5E3C] hover:bg-[#d4af37] rounded-full px-6 h-12 shadow-md text-white font-semibold shrink-0">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon">
            <path d="M8.99992 16V6.41407L5.70696 9.70704C5.31643 10.0976 4.68342 10.0976 4.29289 9.70704C3.90237 9.31652 3.90237 8.6835 4.29289 8.29298L9.29289 3.29298L9.36907 3.22462C9.76184 2.90427 10.3408 2.92686 10.707 3.29298L15.707 8.29298L15.7753 8.36915C16.0957 8.76192 16.0731 9.34092 15.707 9.70704C15.3408 10.0732 14.7618 10.0958 14.3691 9.7754L14.2929 9.70704L10.9999 6.41407V16C10.9999 16.5523 10.5522 17 9.99992 17C9.44764 17 8.99992 16.5523 8.99992 16Z"></path>
          </svg>
        </button>
      </div>
    </div>

    <div id="progressLabel" class="text-center text-sm text-gray-600 hidden"></div>

    <div id="stepsContainer" class="mx-auto w-full max-w-2xl space-y-3"></div>

    <div id="errorDisplay" class="mt-4 p-3 bg-red-100 text-red-700 border border-red-300 rounded-lg hidden">
      <p id="errorMessage"></p>
    </div>

    <!-- Moderation status moved here, just below promptFrame -->
    <div id="moderationStatus" class="mt-2 p-2 rounded text-sm hidden"></div>
  </main>
</div>

  </div>


  <footer class="w-full mt-12 py-8 bg-white border-t border-black text-center" style="font-family: 'Taviraj', serif;">
    <div class="max-w-3xl mx-auto px-4">
      <div id="projectInfo" class="mb-2">
        <div class="text-base font-medium text-[#8B5E3C] mb-4 px-2"><b>ปัญญาประดิษฐ์เพื่อการเป็นมิตรต่อสิ่งแวดล้อมและอยู่ในจริยธรรมทางปัญญาประดิษฐ์ที่ถูกต้อง</b></div>
        <div class="text-base text-gray-700 mb-2">ระดับชั้น ม.3/5</div>
        <div class="text-base text-gray-700 text-left inline-block mx-auto" style="white-space: pre-line;">
1) เด็กชาย นิธิศ โพธิ์ลีลาธรรม เลขที่ 6
2) เด็กชาย ติณณ์ศดิศ บัณฑิตเอกตระกูล เลขที่ 13
3) เด็กชาย ธีรภัทรส์ พงษ์เกษม เลขที่ 14
4) เด็กชาย พัสกร บุญบูรพงค์ เลขที่ 17
5) เด็กชาย แทนคุณ เซี่ยงฉิน เลขที่ 21
6) เด็กชาย ธนกฤต บุญรักษาตระกูล เลขที่ 26
7) เด็กชาย กรวิชญ์ เพียรผลดีสกุล เลขที่ 27
8) เด็กชาย ศุภรุจ ศรีหะรัญ เลขที่ 39
        </div>
      </div>
      <div class="mt-6">
        <b class="text-[#8B5E3C] text-xl">โครงงาน AC Innovation ม.3</b> <br>
        <b class="text-[#8B5E3C] text-xl">Since 29 May 2025</b>
      </div>
      <div class="mt-4 flex flex-col items-center gap-3">
        <a href="index.html" class="px-4 py-2 bg-[#8B5E3C] text-white font-semibold rounded-lg shadow hover:bg-[#d4af37]">LLM for all ></a>
      </div>
    </div>
  </footer>


  <script>
    const moderationStatus = document.getElementById('moderationStatus')
    const WORKER_BASE = 'https://llm-for-all-be.onrender.com'
    const origFetch = window.fetch
    window.fetch = function(input, init){
      try {
        const url = typeof input === 'string' ? input : input.url
        if (typeof url === 'string' && url.startsWith('https://generativelanguage.googleapis.com')) {
          const body = init && init.body ? init.body : null
          return origFetch(`${WORKER_BASE}/call-ai`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body
          })
        }
      } catch (e) {}
      return origFetch(input, init)
    }

    function displayError(msg){
      const e = document.getElementById('errorDisplay')
      const m = document.getElementById('errorMessage')
      m.textContent = msg || 'Unknown error'
      e.classList.remove('hidden')
    }
    function hideError(){
      const e = document.getElementById('errorDisplay')
      const m = document.getElementById('errorMessage')
      m.textContent = ''
      e.classList.add('hidden')
    }
    function processMarkdown(text) {
      if (!text) return ''
      return text
        .replace(/\*\*(.*?)\*\*/g, '$1')
        .replace(/\*(.*?)\*/g, '$1')
        .replace(/^\* /gm, '• ')
        .replace(/\* /g, '• ')
        .replace(/\*/g, '')
        .replace(/<b>(.*?)<\/b>/g, '$1')
        .replace(/<strong>(.*?)<\/strong>/g, '$1')
        .replace(/<i>(.*?)<\/i>/g, '$1')
        .replace(/<em>(.*?)<\/em>/g, '$1')
    }

    const FIXED_API_KEY = "AIzaSyAi7g9ktQXUYoj0F9j_cgTpQQhIM1CVcHQ"

    const generateButton = document.getElementById('generateButton')
    const problemInput = document.getElementById('problemInput')
    const stepsContainer = document.getElementById('stepsContainer')
    const progressLabel = document.getElementById('progressLabel')

    const BASE_PROMPT_CHARS = 1000;
    const BASE_PROMPT_WATER_ML = 0.045;
    const BASE_PROMPT_ENERGY_WH = 0.045;
    const BASELINE_COMPARISON_WH = 18.35;

    function estimateWaterForPrompt(text) {
      const chars = (text || '').length;
      const ml = (chars / BASE_PROMPT_CHARS) * BASE_PROMPT_WATER_ML;
      return Math.max(0.0005, ml);
    }
    function estimateEnergyForPrompt(text) {
      const chars = (text || '').length;
      const wh = (chars / BASE_PROMPT_CHARS) * BASE_PROMPT_ENERGY_WH;
      return Math.max(0.0001, wh);
    }
    function computePercentSaved(energyWh, baselineWh) {
      if (typeof energyWh !== 'number' || typeof baselineWh !== 'number' || baselineWh <= 0) return null;
      let pct = (1 - (energyWh / baselineWh)) * 100;
      if (pct > 98) pct = 98;
      if (pct < -100) pct = -100;
      return pct;
    }

    function updateEnvironmentStats() {
      const text = (problemInput && problemInput.value) ? problemInput.value : '';
      const waterMl = estimateWaterForPrompt(text);
      const energyWh = estimateEnergyForPrompt(text);
      const saved = computePercentSaved(energyWh, BASELINE_COMPARISON_WH);

      const waterEl = document.getElementById('waterUsage');
      const elecEl = document.getElementById('electricUsage');
      const savedEl = document.getElementById('energySaved');

      if (waterEl) waterEl.textContent = (waterMl < 0.001 ? '<0.001' : waterMl.toFixed(3)) + ' ml';
      if (elecEl) elecEl.textContent = (energyWh < 0.001 ? '<0.001' : energyWh.toFixed(3)) + ' Wh';
      if (savedEl) savedEl.textContent = (saved == null ? '0' : saved.toFixed(1)) + '%';
    }

    function showModeration(message, ok, waterMl, energyWh, savedPercent) {
      moderationStatus.style.whiteSpace = 'pre-line';
      moderationStatus.textContent = message;
      if (ok) {
        const lines = [];
        if (typeof waterMl === 'number') {
          const displayVal = waterMl < 0.001 ? '<0.001' : waterMl.toFixed(3);
          lines.push('Estimated water use: ' + displayVal + ' ml');
        }
        if (typeof energyWh === 'number') {
          const displayEnergy = energyWh < 0.001 ? '<0.001' : energyWh.toFixed(3);
          lines.push('Estimated energy use: ' + displayEnergy + ' Wh');
        }
        const charCount = (problemInput.value || '').length;
        const pageCount = Math.ceil(charCount / 2500);
        const co2Kg = pageCount * 0.0045;
        if (co2Kg > 0) {
          lines.push(`CO2 Saved: ~${co2Kg.toFixed(4)} kg`);
        }
        if (lines.length) moderationStatus.textContent += '\n' + lines.join('\n');
      }
      moderationStatus.classList.remove('hidden');
      moderationStatus.className = 'mt-2 p-2 rounded text-sm ' + (ok ? 'bg-green-100 text-green-800 border border-green-300' : 'bg-red-100 text-red-800 border border-red-300');
      if (ok) setTimeout(() => moderationStatus.classList.add('hidden'), 5000);
    }

    function escapeHTML(s){
      return s
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
    }

    function parseSteps(text){
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length)
      const steps = []
      for (const line of lines){
        const m = line.match(/^(?:step\s*)?(\d{1,3})[\.\)\-:]\s*(.+)$/i)
        if (m){
          const idx = Math.max(1, Math.min(100, parseInt(m[1], 10))) - 1
          steps[idx] = m[2]
        } else {
          steps.push(line)
        }
      }
      return steps.filter(Boolean).slice(0, 100)
    }

    function updateProgress(){
      const total = stepsContainer.querySelectorAll('.step-text').length
      const revealed = stepsContainer.querySelectorAll('.step-text:not(.blurred)').length
      if (total === 0){
        progressLabel.classList.add('hidden')
        return
      }
      progressLabel.textContent = `${revealed} of ${total} revealed`
      progressLabel.classList.remove('hidden')
    }

    function renderSteps(steps){
      stepsContainer.innerHTML = ''
      const n = steps.length
      let revealBtn = null;
      for (let i = 0; i < n; i++) {
        const item = document.createElement('div')
        item.className = 'step-card p-3 flex items-start gap-3'
        const num = document.createElement('div')
        num.className = 'step-num'
        num.textContent = String(i + 1)
        const text = document.createElement('div')
        text.className = 'step-text'
        text.dataset.index = String(i)
        text.innerHTML = escapeHTML(steps[i])
        if (i < n - 4) {
          // show text normally (unblurred)
          item.appendChild(num)
          item.appendChild(text)
        } else {
          // last 4 steps: always blurred at first, no reveal button except at n-4
          text.classList.add('blurred')
          item.appendChild(num)
          item.appendChild(text)
          if (i === n - 4) {
            // Insert reveal button for last 4 steps
            const btn = document.createElement('button');
            btn.className = 'px-3 py-1 text-sm bg-[#8B5E3C] hover:bg-[#d4af37] text-white rounded';
            btn.textContent = 'Reveal';
            btn.addEventListener('click', () => {
              const hidden = stepsContainer.querySelectorAll('.step-text.blurred');
              hidden.forEach(h => h.classList.remove('blurred'));
              btn.disabled = true;
              btn.classList.add('opacity-60','cursor-not-allowed');
              updateProgress();
            });
            item.appendChild(btn);
            revealBtn = btn;
          }
        }
        stepsContainer.appendChild(item)
      }
      updateProgress()
    }

    generateButton.addEventListener('click', async () => {
      hideError()
      const apiKey = FIXED_API_KEY
      if (!apiKey){ displayError('Missing API key'); return }
      const userText = problemInput.value.trim()
      if (!userText){ displayError('Please paste a problem or topic.'); return }

      // Show moderation/environment status (always green for this app)
      showModeration(
        "No English moderation required",
        true,
        estimateWaterForPrompt(userText),
        estimateEnergyForPrompt(userText),
        computePercentSaved(estimateEnergyForPrompt(userText), BASELINE_COMPARISON_WH)
      );

      generateButton.disabled = true
      generateButton.textContent = 'Thinking...'
      generateButton.classList.add('bg-gray-400', 'cursor-not-allowed')
      generateButton.classList.remove('bg-[#8B5E3C]')

      let TEACH_PROMPT = [
        'You are a patient teacher.',
        'Produce a solution as numbered steps.',
        'Start at 1 and increment by 1.',
        'One step per line.',
        'All steps before the final step must only describe the reasoning or intermediate process, not the final answer. Do not include the answer in these steps.',
        'The final answer must appear only in the last step. Absolutely do not reveal the final answer in any earlier step.',
        'Stop when complete.',
        'Do not add text before or after the steps.',
        'Match the language of the input.',
        'Maximum 100 steps.',
        'Plain text only.',
        'No answers being shown until the final step, from first to before last step show solution process only like 1 plus 1 equals 2 DO NOT REVEAL 2 to the user (except the last step).',
        '',
        'Problem:',
        userText
      ].join('\n')

      try {
        const payload = { contents: [{ role: 'user', parts: [{ text: TEACH_PROMPT }] }] }
        const modelApiName = 'gemini-2.5-flash'
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelApiName}:generateContent?key=${apiKey}`
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })

        if (!res.ok){
          let err = {}
          try { err = await res.json() } catch {}
          console.error('Tutor API error:', err)
          throw new Error(err.error?.message || 'API error')
        }
        const data = await res.json()
        const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || ''
        const clean = processMarkdown(text).trim()
        const steps = parseSteps(clean)
        if (steps.length === 0){
          throw new Error('No steps returned')
        }
        renderSteps(steps)
      } catch (e) {
        displayError(e.message)
      } finally {
        updateEnvironmentStats();
        generateButton.disabled = false
        generateButton.textContent = 'Create steps'
        generateButton.classList.remove('bg-gray-400', 'cursor-not-allowed')
        generateButton.classList.add('bg-[#8B5E3C]')
      }
    })

    problemInput.addEventListener('keydown', (e) => {
      if (e.shiftKey && e.key === 'Enter'){
        e.preventDefault()
        generateButton.click()
      }
    })

    if (problemInput) {
      problemInput.addEventListener('input', updateEnvironmentStats);
    }
    window.addEventListener('load', updateEnvironmentStats);
  </script>


</body>
</html>