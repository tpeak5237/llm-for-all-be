<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Summarizer for all by LLM for All</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Taviraj:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Taviraj', serif;
      line-height: 1.65;
      background: linear-gradient(135deg, #f8fafc 0%, #e0e7ef 100%);
      min-height: 100vh;
      background-image: url('https://www.transparenttextures.com/patterns/cubes.png');
    }
    h1, h2, h3 {
      font-family: 'Playfair Display', 'Taviraj', serif;
      font-weight: 700;
      line-height: 1.2;
      letter-spacing: -0.01em;
    }
    .main-card {
      background: rgba(255,255,255,0.95);
      max-width: 72rem;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 6px 32px 0 rgba(139,94,60,0.13), 0 1.5px 6px 0 rgba(212,175,55,0.08);
      border-radius: 1.5rem;
      border: 2px solid #8B5E3C;
      padding: 2rem;
      transition: box-shadow 0.3s, transform 0.2s;
    }
    .file-input-label { display:inline-flex; align-items:center; justify-content:center; width:auto; height:auto; min-width:44px; min-height:44px; padding:0.35rem; background:linear-gradient(135deg,#f3f4f6 80%,#fee2e2 100%); border:2px dashed #d1d5db; border-radius:0.5rem; cursor:pointer; }
    .file-input-label:hover { border-color:#ef4444; }
    .btn-red {
      background: #8B5E3C;
      color: #fff;
      font-family: 'Taviraj', serif;
      border-radius: 9999px;
      padding: 0.75rem 2rem;
    }
    .btn-red.disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    .result-tabs button { padding:0.5rem 0.8rem; border-radius:0.4rem; }
    .bar { height:12px; width:100%; background:#e5e7eb; border-radius:8px; overflow:hidden; }
    .bar span { height:100%; display:block; width:0%; transition:width 0.6s ease; }
    .ai-fill { background:#ef4444; }
    .human-fill { background:#22c55e; }
  </style>
</head>
<body>


  <div class="main-card">
    <header class="mb-4 relative">
      <h1 class="text-3xl font-extrabold text-[#8B5E3C] text-center mt-6">Summarizer for all by LLM for All</h1>
    </header>

    <main class="mt-4 md:mt-10">
      <div class="mb-4 flex flex-wrap items-stretch gap-3">
        <label class="file-input-label shrink-0 w-11 h-11 md:w-14 md:h-14 p-1 md:p-[0.35rem]" title="Upload file">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>
          <input id="fileInput" type="file" accept="application/pdf,image/*" class="hidden" multiple />
        </label>
        <textarea id="promptInput" rows="4" placeholder="Paste text to summarize" class="flex-1 min-w-[60%] md:min-w-0 px-3 py-2 rounded border text-base md:text-lg leading-normal md:leading-relaxed" style="min-height:4rem; resize:vertical"></textarea>
        <button id="summarizeBtn" class="btn-red shrink-0 px-5 py-3 rounded">Summarize</button>
      </div>
      <!-- <p class="text-xs text-gray-500 text-center -mt-2 mb-4">Powered by LLMall 1</p> -->

      <div id="filePreview" class="mb-4 text-sm text-gray-600 hidden">
        <div id="fileNames"></div>
        <div id="thumbs" class="flex gap-2 mt-2"></div>
        <button id="removeFiles" class="text-red-600 mt-2 underline">Remove</button>
      </div>

      <div id="statusArea" class="mb-4 text-sm hidden"></div>

      <div id="resultArea" class="hidden">
        <div class="mb-2 result-tabs flex gap-2">
          <button data-tab="tldr" class="px-3 py-1 bg-gray-100 rounded">TLDR</button>
          <button data-tab="key" class="px-3 py-1 bg-gray-100 rounded">Key points</button>
          <button data-tab="notes" class="px-3 py-1 bg-gray-100 rounded">Study notes</button>
        </div>
        <div id="tldr" class="p-3 bg-sky-50 rounded mb-2 hidden"></div>
        <div id="key" class="p-3 bg-sky-50 rounded mb-2 hidden"></div>
        <div id="notes" class="p-3 bg-sky-50 rounded mb-2 hidden"></div>
        <div class="flex items-center gap-3">
          <button id="copyBtn" class="px-3 py-2 border rounded">Copy</button>
          <div class="flex-1">
            <div class="bar"><span id="progressFill" class="ai-fill"></span></div>
          </div>
        </div>
      </div>

      <div id="errorArea" class="mt-4 p-3 bg-red-100 text-red-700 rounded hidden"></div>

      <div id="ecoStats" class="mt-4 p-3 bg-green-100 text-green-800 border border-green-200 rounded hidden"></div>

    </main>
  </div>

  <footer class="w-full mt-12 py-8 bg-white border-t border-black text-center" style="font-family: 'Taviraj', serif;">
    <div class="max-w-3xl mx-auto px-4">
      <div id="projectInfo" class="mb-2">
        <div class="text-sm font-medium text-[#8B5E3C] mb-2" style="font-family:'Taviraj', serif;"><b>ปัญญาประดิษฐ์เพื่อการเป็นมิตรต่อสิ่งแวดล้อมและอยู่ในจริยธรรมทางปัญญาประดิษฐ์ที่ถูกต้อง</b></div>
        <div class="text-base text-gray-700 mb-2">ระดับชั้น ม.3/5</div>
        <div class="text-base text-gray-700 text-left inline-block mx-auto" style="white-space: pre-line;">
1) เด็กชาย นิธิศ โพธิ์ลีลาธรรม เลขที่ 6
2) เด็กชาย ติณณ์ศดิศ บัณฑิตเอกตระกูล เลขที่ 13
3) เด็กชาย ธีรภัทรส์ พงษ์เกษม เลขที่ 14
4) เด็กชาย พัสกร บุญบูรพงษ์ เลขที่ 17
5) เด็กชาย แทนคุณ เซี่ยงฉิน เลขที่ 21
6) เด็กชาย ธนกฤต บุญรักษาตระกูล เลขที่ 26
7) เด็กชาย กรวิชญ์ เพียรผลดีสกุล เลขที่ 27
8) เด็กชาย ศุภรุจ ศรีหะรัญ เลขที่ 39
        </div>
      </div>
      <div class="mt-6">
        <b class="text-[#8B5E3C] text-base" style="font-family:'Taviraj', serif;">โครงงาน AC Innovation ม.3</b> <br>
        <b class="text-[#8B5E3C] text-base" style="font-family:'Taviraj', serif;">Since 29 May 2025</b>
      </div>
      <div class="mt-4 flex flex-col items-center gap-3">
        <a href="index.html" class="px-4 py-2 bg-[#8B5E3C] text-white font-semibold rounded-lg shadow hover:bg-[#d4af37]" style="font-family:'Taviraj', serif;">LLM for all &gt;</a>
   
      </div>
    </div>
  </footer>

  <script>
    const FIXED_API_KEY = "AIzaSy Ai7g9ktQXUYoj0F9j_cgTpQQhIM1CVcHQ";
    const WORKER_BASE = 'https://llm-for-all-be.onrender.com';
const origFetch = window.fetch;
window.fetch = function(input, init){
  try {
    const url = typeof input === 'string' ? input : input.url;
    if (typeof url === 'string' && url.startsWith('https://generativelanguage.googleapis.com')) {
      const body = init && init.body ? init.body : null;
      return origFetch(`${WORKER_BASE}/call-ai`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body
      });
    }
  } catch (e) {}
  return origFetch(input, init);
};

    const MODEL = 'gemma-3-27b-it';

    

    const fileInput = document.getElementById('fileInput');
    const promptInput = document.getElementById('promptInput');
    const filePreview = document.getElementById('filePreview');
    const fileNames = document.getElementById('fileNames');
    const thumbs = document.getElementById('thumbs');
    const removeFiles = document.getElementById('removeFiles');
    const summarizeBtn = document.getElementById('summarizeBtn');
    const statusArea = document.getElementById('statusArea');
    const resultArea = document.getElementById('resultArea');
    const tldrDiv = document.getElementById('tldr');
    const keyDiv = document.getElementById('key');
    const notesDiv = document.getElementById('notes');
    const errorArea = document.getElementById('errorArea');
    const copyBtn = document.getElementById('copyBtn');
    const progressFill = document.getElementById('progressFill');

    let uploadedFiles = [];

    fileInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files).filter(f => f.size > 0);
      if (!files.length) return;
      uploadedFiles = [];
      fileNames.textContent = files.map(f => f.name).join(', ');
      thumbs.innerHTML = '';
      for (const f of files) {
        if (!['application/pdf'].includes(f.type) && !f.type.startsWith('image/')) continue;
        uploadedFiles.push(f);
        if (f.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = () => {
            const img = document.createElement('img');
            img.src = reader.result;
            img.style.width = '80px'; img.style.height = '80px'; img.style.objectFit = 'cover'; img.style.borderRadius = '6px'; img.style.border = '1px solid #e5e7eb';
            thumbs.appendChild(img);
          };
          reader.readAsDataURL(f);
        }
      }
      filePreview.classList.remove('hidden');
    });

    removeFiles.addEventListener('click', () => {
      fileInput.value = '';
      uploadedFiles = [];
      filePreview.classList.add('hidden');
      fileNames.textContent = '';
      thumbs.innerHTML = '';
    });

    function showError(msg) { errorArea.textContent = msg; errorArea.classList.remove('hidden'); }
    function hideError() { errorArea.classList.add('hidden'); errorArea.textContent = ''; }

    function estimateWater(chars) {
      const BASE_PROMPT_CHARS = 1000;
      const BASE_PROMPT_WATER_ML = 0.045; // Gemma 27B ~0.045 mL per 1000 chars
      const ml = (chars / BASE_PROMPT_CHARS) * BASE_PROMPT_WATER_ML;
      return Math.max(0.0005, ml);
    }

    function estimateEnergy(chars) {
      const BASE_PROMPT_CHARS = 1000;
      const BASE_PROMPT_ENERGY_WH = 0.045; // Gemma 27B ~0.045 Wh per 1000 chars
      const wh = (chars / BASE_PROMPT_CHARS) * BASE_PROMPT_ENERGY_WH;
      return Math.max(0.0001, wh);
    }

    function showEcoStats(charCount) {
      const ecoStatsEl = document.getElementById('ecoStats');
      if (!ecoStatsEl) return;
      const waterMl = estimateWater(charCount);
      const energyWh = estimateEnergy(charCount);
      const pageCount = Math.ceil(charCount / 2500);
      const co2Kg = pageCount * 0.0045; // Using average of 0.0043 and 0.0047
      let stats = [];
      stats.push(`Est. water: ${waterMl.toFixed(3)} ml`);
      stats.push(`Est. energy: ${energyWh.toFixed(3)} Wh`);
      if (co2Kg > 0) {
        stats.push(`CO2 Saved: ~${co2Kg.toFixed(4)} kg`);
      }
      ecoStatsEl.innerHTML = stats.join(' &bull; ');
      ecoStatsEl.classList.remove('hidden');
      setTimeout(() => ecoStatsEl.classList.add('hidden'), 8000);
    }

    function setBusy(isBusy) {
      if (isBusy) {
        summarizeBtn.disabled = true;
        summarizeBtn.classList.add('disabled');
        summarizeBtn.textContent = 'Generating...';
      } else {
        summarizeBtn.disabled = false;
        summarizeBtn.classList.remove('disabled');
        summarizeBtn.textContent = 'Summarize';
      }
    }

    summarizeBtn.addEventListener('click', async () => {
      hideError();
      resultArea.classList.add('hidden');
      const userText = (promptInput.value || '').trim();
      if (!userText && uploadedFiles.length === 0) { showError('Please add text or upload a PDF or image.'); return; }

      setBusy(true);
      statusArea.classList.add('hidden');

      // build prompt
     let instruction = `Summarize the provided material into three sections. Use these exact markers. ===TLDR===, ===KEY POINTS===, ===STUDY NOTES===. Keep simple sentences. If input is Thai, respond in Thai. Key points and study notes must be detailed and longer than usual. If the material is mathematics or science, include at least one relevant equation in the TLDR section.`;
      let parts = [];
      parts.push({ text: instruction });
      if (userText) parts.push({ text: userText.slice(0, 50000) });

      // attach files as inline base64
      for (const f of uploadedFiles) {
        try {
          const b64 = await readFileAsBase64(f);
          parts.push({ inline_data: { data: b64, mime_type: f.type } });
        } catch (err) {
          console.error('file read error', err);
        }
      }

      const payload = { contents: [{ role: 'user', parts: parts }] };

      try {
        progressFill.style.width = '10%';
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${FIXED_API_KEY}`;
        const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!res.ok) {
          const err = await res.text();
          throw new Error(err || 'API error');
        }
        const data = await res.json();
        const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
        progressFill.style.width = '80%';
        parseAndShow(text);
        showEcoStats(userText.length + text.length);
        progressFill.style.width = '100%';
      } catch (e) {
        console.error(e);
        showError('Error generating summary. See console for details.');
      } finally {
        setBusy(false);
        setTimeout(()=>{ progressFill.style.width = '0%'; }, 800);
      }
    });

    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const res = reader.result || '';
          const comma = res.indexOf(',');
          const b64 = comma >= 0 ? res.slice(comma + 1) : res;
          resolve(b64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function parseAndShow(raw) {
      const out = raw || '';
      const tldr = extractSection(out, 'TLDR');
      const key = extractSection(out, 'KEY POINTS');
      const notes = extractSection(out, 'STUDY NOTES');
      tldrDiv.innerHTML = sanitizeForDisplay(tldr || 'No TLDR returned.');
      keyDiv.innerHTML = sanitizeForDisplay(key || 'No key points returned.');
      notesDiv.innerHTML = sanitizeForDisplay(notes || 'No study notes returned.');
      resultArea.classList.remove('hidden');
      showTab('tldr');
    }

    function extractSection(text, name) {
      const marker = '===' + name + '===';
      const idx = text.indexOf(marker);
      if (idx < 0) return '';
      // find next marker
      const rest = text.slice(idx + marker.length);
      const next = rest.search(/===[A-Z ]+===/);
      if (next >= 0) return rest.slice(0, next).trim();
      return rest.trim();
    }

    function sanitizeForDisplay(s) { return s.replace(/\*+/g, '').replace(/<[^>]+>/g, ''); }

    function showTab(id) {
      ['tldr','key','notes'].forEach(x => document.getElementById(x).classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    }

    document.querySelectorAll('.result-tabs button').forEach(btn => btn.addEventListener('click', () => showTab(btn.getAttribute('data-tab'))));

    copyBtn.addEventListener('click', () => {
      const text = tldrDiv.textContent + '\n\n' + keyDiv.textContent + '\n\n' + notesDiv.textContent;
      navigator.clipboard.writeText(text);
    });

  </script>
</body>
</html>
