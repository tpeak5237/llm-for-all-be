<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Detector for all</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Taviraj:wght@400;600;700&display=swap" rel="stylesheet">
  <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
  <style>
    body {
      font-family: 'Taviraj', serif;
      line-height: 1.65;
      background: linear-gradient(135deg, #f8fafc 0%, #e0e7ef 100%);
      min-height: 100vh;
      background-image: url('https://www.transparenttextures.com/patterns/cubes.png');
    }
    h1, h2, h3 {
      font-family: 'Playfair Display', 'Taviraj', serif;
      font-weight: 700;
      line-height: 1.2;
      letter-spacing: -0.01em;
    }
    .main-card {
      background: rgba(255,255,255,0.95);
      max-width: 72rem;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 6px 32px 0 rgba(139,94,60,0.13), 0 1.5px 6px 0 rgba(212,175,55,0.08);
      border-radius: 1.5rem;
      border: 2px solid #8B5E3C;
      padding: 2rem;
      transition: box-shadow 0.3s, transform 0.2s;
    }
    .main-card:hover {
      box-shadow: 0 20px 60px 0 rgba(139,94,60,0.22), 0 4px 16px 0 rgba(212,175,55,0.13);
      transform: scale(1.01);
    }
    .prompt-frame {
      transition: box-shadow 0.3s, border-color 0.3s, transform 0.5s cubic-bezier(.4,2,.6,1);
      box-shadow: 0 4px 24px 0 rgba(139,94,60,0.10);
      border: 2.5px solid #8B5E3C;
      border-radius: 1.25rem;
      background: linear-gradient(90deg, #fff 80%, #f1f5f9 100%);
      position: relative;
    }
    #resultCard.likely-ai { border-color: #ef4444; }
    #resultCard.likely-human { border-color: #22c55e; }
    .bar {
      height: 14px;
      border-radius: 8px;
      background: #e5e7eb;
      position: relative;
      overflow: hidden;
    }
    .bar > span {
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 0%;
      transition: width 0.6s ease;
    }
    .bar .fill-ai { background: #ef4444; }
    .bar .fill-human { background: #22c55e; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex items-center justify-center flex-col p-4 selection:bg-red-500 selection:text-white">

  <div class="main-card p-0 md:p-0 w-full max-w-5xl flex space-x-0 md:space-x-6 border-0 md:border-2 border-gray-300">
    <div class="flex-grow w-2/3 flex flex-col px-2 md:px-8 py-6">
      <header class="mb-6 relative">
        <h1 class="text-4xl md:text-5xl font-extrabold text-[#8B5E3C] drop-shadow-sm tracking-tight header-title text-center">AI Detector for all</h1>
        <p class="text-[#8B5E3C] mt-2 text-base md:text-lg font-medium text-center">รู้นะ ว่าใครใช้ AI ทำงาน</p>
      </header>

      <main class="flex-grow flex flex-col">

        <!-- Detector input -->
        <div id="promptFrame" class="flex items-center bg-gray-100 rounded-full px-4 py-4 w-full max-w-2xl mb-4 border border-[#8B5E3C] shadow mx-auto">
          <label for="fileInput" class="file-input-label mr-3" title="Upload a file" style="width:56px;height:56px;padding:0.35rem;">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="28" height="28">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
          </label>
          <input type="file" id="fileInput" multiple style="display:none;">
          <textarea 
            id="detectorInput"
            rows="1"
            placeholder="Paste text to check..."
            class="flex-grow bg-transparent text-gray-800 placeholder-gray-400 focus:outline-none resize-none overflow-hidden min-h-[3.5rem] max-h-[22rem] py-1"
          ></textarea>
          <button id="checkButton" class="bg-[#8B5E3C] hover:bg-[#d4af37] rounded-full px-6 py-3 shadow-md text-white font-semibold ml-3">
            Detect AI
          </button>
        </div>
        <!-- <p class="text-xs text-gray-500 text-center -mt-2 mb-4">Powered by LLMall 1</p> -->

        <div id="ocrStatus" class="text-center hidden max-w-2xl mx-auto mb-6"></div>

        <div id="imagePreviewContainer" class="text-left hidden max-w-2xl mx-auto mb-6">
          <div id="fileName" class="text-xs text-gray-500 truncate max-w-[150px]"></div>
          <div id="imagePreview" class="flex flex-wrap gap-2 mt-2"></div>
          <button id="removeImageButton" class="text-xs text-red-600 hover:text-red-800 underline">Remove</button>
        </div>

        <!-- Result -->
        <div id="resultCard" class="mx-auto w-full max-w-2xl p-4 border rounded-lg bg-white hidden">
          <div class="flex items-baseline justify-between mb-2">
            <div class="text-lg font-semibold">Result</div>
            <div id="percentLabel" class="text-2xl font-extrabold text-red-600">0%</div>
          </div>
          <div class="bar mb-3">
            <span id="percentFill" class="fill-ai"></span>
          </div>
          <div id="verdict" class="text-sm text-gray-700 mb-2"></div>
          <div id="comment" class="text-gray-700"></div>
        </div>

        <div id="ecoStats" class="mx-auto w-full max-w-2xl mt-3 p-2 rounded text-sm hidden bg-green-100 text-green-800 border border-green-300"></div>

        <!-- Errors -->
        <div id="errorDisplay" class="mt-4 p-3 bg-red-100 text-red-700 border border-red-300 rounded-lg hidden">
          <p id="errorMessage"></p>
        </div>
      </main>
    </div>
  </div>

  <footer class="w-full mt-12 py-8 bg-white border-t border-black text-center" style="font-family: 'Taviraj', serif;">
    <div class="max-w-3xl mx-auto px-4">
      <div id="projectInfo" class="mb-2">
        <div class="text-base font-medium text-[#8B5E3C] mb-4 px-2"><b>ปัญญาประดิษฐ์เพื่อการเป็นมิตรต่อสิ่งแวดล้อมและอยู่ในจริยธรรมทางปัญญาประดิษฐ์ที่ถูกต้อง</b></div>
        <div class="text-base text-gray-700 mb-2">ระดับชั้น ม.3/5</div>
        <div class="text-base text-gray-700 text-left inline-block mx-auto" style="white-space: pre-line;">
1) เด็กชาย นิธิศ โพธิ์ลีลาธรรม เลขที่ 6
2) เด็กชาย ติณณ์ศดิศ บัณฑิตเอกตระกูล เลขที่ 13
3) เด็กชาย ธีรภัทรส์ พงษ์เกษม เลขที่ 14
4) เด็กชาย พัสกร บุญบูรพงษ์ เลขที่ 17
5) เด็กชาย แทนคุณ เซี่ยงฉิน เลขที่ 21
6) เด็กชาย ธนกฤต บุญรักษาตระกูล เลขที่ 26
7) เด็กชาย กรวิชญ์ เพียรผลดีสกุล เลขที่ 27
8) เด็กชาย ศุภรุจ ศรีหะรัญ เลขที่ 39
        </div>
      </div>
      <div class="mt-6">
        <b class="text-[#8B5E3C] text-xl">โครงงาน AC Innovation ม.3</b> <br>
        <b class="text-[#8B5E3C] text-xl">Since 29 May 2025</b>
      </div>
      <div class="mt-4 flex flex-col items-center gap-3">
        <a href="index.html" class="px-4 py-2 bg-[#8B5E3C] text-white font-semibold rounded-lg shadow hover:bg-[#d4af37]">LLM for all &gt;</a>
      </div>
    </div>
  </footer>

  <script>
    const WORKER_BASE = 'https://llm-for-all-be.onrender.com';
const origFetch = window.fetch;
window.fetch = function(input, init){
  try {
    const url = typeof input === 'string' ? input : input.url;
    if (typeof url === 'string' && url.startsWith('https://generativelanguage.googleapis.com')) {
      const body = init && init.body ? init.body : null;
      return origFetch(`${WORKER_BASE}/call-ai`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body
      });
    }
  } catch (e) {}
  return origFetch(input, init);
};

    // Simple helpers
    function displayError(msg){
      const e = document.getElementById('errorDisplay');
      const m = document.getElementById('errorMessage');
      m.textContent = msg || 'Unknown error';
      e.classList.remove('hidden');
    }
    function hideError(){
      const e = document.getElementById('errorDisplay');
      const m = document.getElementById('errorMessage');
      m.textContent = '';
      e.classList.add('hidden');
    }
    function processMarkdown(text) {
      if (!text) return '';
      return text
        .replace(/\*\*(.*?)\*\*/g, '$1')
        .replace(/\*(.*?)\*/g, '$1')
        .replace(/^\* /gm, '• ')
        .replace(/\* /g, '• ')
        .replace(/\*/g, '')
        .replace(/<b>(.*?)<\/b>/g, '$1')
        .replace(/<strong>(.*?)<\/strong>/g, '$1')
        .replace(/<i>(.*?)<\/i>/g, '$1')
        .replace(/<em>(.*?)<\/em>/g, '$1');
    }

    // Eco stats helpers
    function estimateWater(chars) {
      const BASE_PROMPT_CHARS = 1000;
      const BASE_PROMPT_WATER_ML = 0.045; // Gemma 27B ~0.045 mL per 1000 chars
      const ml = (chars / BASE_PROMPT_CHARS) * BASE_PROMPT_WATER_ML;
      return Math.max(0.0005, ml);
    }
    function estimateEnergy(chars) {
      const BASE_PROMPT_CHARS = 1000;
      const BASE_PROMPT_ENERGY_WH = 0.045; // Gemma 27B ~0.045 Wh per 1000 chars
      const wh = (chars / BASE_PROMPT_CHARS) * BASE_PROMPT_ENERGY_WH;
      return Math.max(0.0001, wh);
    }
    function showEcoStats(charCount) {
      const ecoStatsEl = document.getElementById('ecoStats');
      if (!ecoStatsEl) return;
      const waterMl = estimateWater(charCount);
      const energyWh = estimateEnergy(charCount);
      const pageCount = Math.ceil(charCount / 2500);
      const co2Kg = pageCount * 0.0045; // Using average of 0.0043 and 0.0047
      ecoStatsEl.innerHTML = `Est. water: ${waterMl.toFixed(3)} ml &bull; Est. energy: ${energyWh.toFixed(3)} Wh &bull; CO2 Saved: ~${co2Kg.toFixed(4)} kg`;
      ecoStatsEl.classList.remove('hidden');
      setTimeout(() => ecoStatsEl.classList.add('hidden'), 8000);
    }

    


    // Use hardcoded API key for testing (user accepted risk)
    const FIXED_API_KEY = "AIzaSyAi7g9ktQXUYoj0F9j_cgTpQQhIM1CVcHQ";

    // Detector call
    const checkButton = document.getElementById('checkButton');
    const detectorInput = document.getElementById('detectorInput');

    // File upload logic (like index.html)
    const fileInput = document.getElementById('fileInput');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const imagePreview = document.getElementById('imagePreview');
    const fileNameDisplay = document.getElementById('fileName');
    const removeImageButton = document.getElementById('removeImageButton');
    let uploadedFiles = [];

    fileInput.addEventListener('change', (event) => {
      const files = Array.from(event.target.files);
      uploadedFiles = files;
      fileNameDisplay.textContent = files.map(f => f.name).join(', ');
      imagePreviewContainer.classList.remove('hidden');
      imagePreview.innerHTML = '';
      files.forEach(file => {
        if (file.type && file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.alt = file.name;
            img.className = 'w-16 h-16 object-cover rounded border';
            imagePreview.appendChild(img);
          };
          reader.readAsDataURL(file);
        }
      });
    });

    removeImageButton.addEventListener('click', () => {
      fileInput.value = '';
      uploadedFiles = [];
      fileNameDisplay.textContent = '';
      imagePreviewContainer.classList.add('hidden');
      imagePreview.innerHTML = '';
    });

checkButton.addEventListener('click', async () => {
  hideError();
  const apiKey = FIXED_API_KEY;
  if (!apiKey) { displayError('Missing API key'); return; }
  let userText = detectorInput.value.trim();

  // OCR extraction logic (unchanged)
  if (!userText && uploadedFiles.length > 0) {
    let extractedText = '';
    const statusEl = document.getElementById('ocrStatus');
    statusEl.classList.remove('hidden');
    statusEl.textContent = 'Extracting text from files...';
    for (const file of uploadedFiles) {
      if (file.type && file.type.startsWith('image/')) {
        try {
          const result = await Tesseract.recognize(file, 'eng');
          extractedText += result.data.text + '\n';
        } catch (err) {
          console.error('OCR failed:', err);
        }
      }
      else if (file.type === 'text/plain') {
        try {
          const text = await file.text();
          extractedText += text + '\n';
        } catch (err) {
          console.error('Text file read failed:', err);
        }
      }
    }
    statusEl.classList.add('hidden');
    userText = extractedText.trim();
  }

  // New logic for error and placeholder
  if (!userText && uploadedFiles.length === 0) {
    displayError('Please upload a file or paste text.');
    return;
  }

  if (!userText && uploadedFiles.length > 0) {
    userText = "[No text extracted, but a file was provided]";
  }

  checkButton.disabled = true;
  checkButton.textContent = 'Detecting...';
  checkButton.classList.add('bg-gray-400', 'cursor-not-allowed');
  checkButton.classList.remove('bg-red-600', 'hover:bg-red-700');

  let DETECTOR_PROMPT = [
    'You classify writing origin.',
    'Estimate the probability the provided text was generated by an AI system as an integer 0-100.',
    'Output exactly two lines:',
    'Line 1: PERCENT%',
    'Line 2: one sentence comment explaining the reasoning.',
    'No extra text.',
    '',
    'Text:',
    userText
  ].join('\n');

  if (uploadedFiles.length > 0) {
    DETECTOR_PROMPT += '\n\nUploaded files:\n' + uploadedFiles.map(f => f.name).join(', ');
  }

  try {
    const payload = { contents: [{ role: 'user', parts: [{ text: DETECTOR_PROMPT }] }] };
    const modelApiName = 'gemini-2.5-flash';
    const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelApiName}:generateContent?key=${apiKey}`;
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      let err = {};
      try { err = await res.json(); } catch {}
      console.error("Detector API error:", err);
      throw new Error(err.error?.message || 'API error');
    }
    const data = await res.json();
    const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const clean = processMarkdown(text).trim();

    // Parse "PERCENT%" on first line, comment on second
    const lines = clean.split(/\r?\n/);
    const first = (lines[0] || '').trim();
    const second = (lines[1] || '').trim();
    const match = first.match(/(\d{1,3})\s*%/);
    let pct = match ? parseInt(match[1], 10) : 0;
    if (isNaN(pct) || pct < 0) pct = 0;
    if (pct > 100) pct = 100;

    renderResult(pct, second || 'No comment returned.');
    showEcoStats(userText.length);
  } catch (e) {
    displayError(e.message);
  } finally {
    checkButton.disabled = false;
    checkButton.textContent = 'Detect AI';
    checkButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
    checkButton.classList.add('bg-red-600', 'hover:bg-red-700');
  }
});

    function renderResult(percent, comment) {
      const card = document.getElementById('resultCard');
      const label = document.getElementById('percentLabel');
      const fill = document.getElementById('percentFill');
      const verdict = document.getElementById('verdict');
      const commentDiv = document.getElementById('comment');

      label.textContent = percent + '%';
      const likelyAI = percent >= 50;
      card.classList.remove('likely-ai','likely-human');
      card.classList.add(likelyAI ? 'likely-ai' : 'likely-human');
      fill.className = likelyAI ? 'fill-ai' : 'fill-human';
      fill.style.width = percent + '%';
      verdict.textContent = likelyAI ? 'Likely AI' : 'Likely Human';
      commentDiv.textContent = comment;
      card.classList.remove('hidden');
    }

    // Allow Enter + Shift to submit
    detectorInput.addEventListener('keydown', (e) => {
      if (e.shiftKey && e.key === 'Enter') {
        e.preventDefault();
        checkButton.click();
      }
    });
  </script>
</body>
</html>